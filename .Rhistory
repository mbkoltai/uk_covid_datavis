set.seed(1)
samples <- run(x0, f, q, 1000)
run()
run
image(x, y, z, xlim=range(x, samples[,1]), ylim=range(x, samples[,2]))
contour(x, y, z, add=TRUE)
lines(samples[,1], samples[,2], col="#00000088")
set.seed(1)
samples <- run(x0, f, q, 100000)
smoothScatter(samples)
contour(x, y, z, add=TRUE)
start_date
eng_case_age_data
start_date<-"2021-09-01"
for (k_plot in 1:3){
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,14,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
max(eng_case_age_data$date)
url_cases_age="https://api.coronavirus.data.gov.uk/v2/data?areaType=nation&areaCode=E92000001&metric=newCasesBySpecimenDateAgeDemographics&format=csv"
# c(1:5,6:9,10:14,15:19)
eng_case_age_data <- read_csv(url_cases_age)
eng_case_age_data <- eng_case_age_data %>% filter(!age %in% c("unassigned","00_59","60+")) %>%
mutate(age_num=as.numeric(factor(age)),
age_categ=case_when(age_num<=5 ~ "0-24",age_num>=6&age_num<=10 ~ "25-49",
age_num>=11 & age_num<=15 ~ "50-74", age_num>15 ~ "75+"),
age_num=age_num-(as.numeric(factor(age_categ))-1)*5) %>%  group_by(age) %>%
mutate(rollingsum_chng=rollingSum/lag(rollingSum,n=7,order_by=date))
for (k_plot in 1:3){
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,14,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
max(eng_case_age_data$date)
eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,14,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
start_date<-"2021-09-01"
for (k_plot in 1:3){
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,14,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
max(eng_case_age_data$date)
2^seq(3,14,by = 1)
start_date<-"2021-09-01"
for (k_plot in 1:3){
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
start_date<-"2021-09-01"
for (k_plot in 1:3){
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(aes(x=date,y=rollingSum,color=order_within,size=ifelse(date>max(date)-5),1,0),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
k_plot
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(aes(x=date,y=rollingSum,color=order_within,size=ifelse(date>max(date)-5,1,0),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(aes(x=date,y=rollingSum,color=order_within,size=ifelse(date>max(date)-5,1,0)),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(aes(x=date,y=rollingSum,color=order_within,size=ifelse(date>max(date)-5,1/4,0)),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
p<-eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date)) %>%
ggplot() + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(aes(x=date,y=rollingSum,color=order_within,size=ifelse(date>max(date)-5,1/10,0)),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
df_plot <- eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date))
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-5),aes(x=date,y=rollingSum,color=order_within),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
df_plot %>% filter(date>max(date)-5)
dim(df_plot %>% filter(date>max(date)-5))
dim(df_plot)
dim(df_plot %>% filter(date>as.Date(max(date)-5)))
max(df_plot$date)
unique(df_plot$date)
url_cases_age="https://api.coronavirus.data.gov.uk/v2/data?areaType=nation&areaCode=E92000001&metric=newCasesBySpecimenDateAgeDemographics&format=csv"
# c(1:5,6:9,10:14,15:19)
eng_case_age_data <- read_csv(url_cases_age)
eng_case_age_data <- eng_case_age_data %>% filter(!age %in% c("unassigned","00_59","60+")) %>%
mutate(age_num=as.numeric(factor(age)),
age_categ=case_when(age_num<=5 ~ "0-24",age_num>=6&age_num<=10 ~ "25-49",
age_num>=11 & age_num<=15 ~ "50-74", age_num>15 ~ "75+"),
age_num=age_num-(as.numeric(factor(age_categ))-1)*5) %>%  group_by(age) %>%
mutate(rollingsum_chng=rollingSum/lag(rollingSum,n=7,order_by=date))
#
agegr_names=gsub("09","9",gsub("04","4",gsub("^0","",gsub("_","-",unique(eng_case_age_data$age)))))
l_num=lapply(1:4, function(x) (x-1)*5+1:5); l_num[[4]]=l_num[[4]][1:4];
agegr_names=paste0(unlist(lapply(l_num, function(x)
paste0("[",paste0(agegr_names[x],collapse=","),"]"))),collapse=", ")
max(df_plot$date)
df_plot <- eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>% filter(date>as.Date(start_date))
max(df_plot$date)
dim(df_plot %>% filter(date>as.Date(max(date)-5)))
dim(df_plot)
class(df_plot$date)
class(max(df_plot$date))
class(max(df_plot$date)-5)
(max(df_plot$date)-5)
dim(df_plot %>% ungroup() %>% filter(date>as.Date(max(date)-5)))
df_plot <- eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>% ungroup()
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-5),aes(x=date,y=rollingSum,color=order_within),shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-5),aes(x=date,y=rollingSum,color=order_within),size=1/2,shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-5),aes(x=date,y=rollingSum,color=order_within),size=1,shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-5),aes(x=date,y=rollingSum,color=order_within),size=1.5,shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
for (k_plot in 1:3){
df_plot <- eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>% ungroup()
# PLOT
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-8),aes(x=date,y=rollingSum,color=order_within),size=1.5,shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:12)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
start_date<-"2021-10-01"
for (k_plot in 1:3){
df_plot <- eng_case_age_data %>% mutate(ten_year_band_num=round(as.numeric(strsplit(age,"_")[[1]][2])/10)*10,
ten_year_band_num=ifelse(is.na(ten_year_band_num),90,ten_year_band_num),
ten_year_band=ifelse(ten_year_band_num-5<0,"<5",paste0(ten_year_band_num-5,"_",ten_year_band_num+4))) %>%
mutate(ten_year_band=ifelse(is.na(ten_year_band)|grepl("85",ten_year_band),">85",ten_year_band)) %>%
group_by(date,ten_year_band) %>%
summarise(rollingSum=sum(rollingSum)/7,ten_year_band_num=unique(ten_year_band_num)/10) %>%
mutate(ten_year_band_num=ifelse(is.na(ten_year_band_num),9,ten_year_band_num)+1,
age_meta=round((ten_year_band_num+0.9)/2)) %>% ungroup() %>% arrange(date,ten_year_band_num) %>%
mutate(ten_year_band=factor(ten_year_band,levels=unique(ten_year_band))) %>% group_by(age_meta,date) %>%
mutate(order_within=c("lower","higher")[row_number()],
age_meta_name=paste0("[",paste0(ten_year_band,collapse=", "),"]",sep="")) %>%
filter(date>as.Date(start_date)) %>% ungroup()
# PLOT
p <- ggplot(df_plot) + geom_line(aes(x=date,y=rollingSum,color=order_within),size=1.1) +
geom_point(data=df_plot %>% filter(date>max(date)-8),aes(x=date,y=rollingSum,color=order_within),size=1.5,shape=21) +
facet_wrap(~age_meta_name,nrow=2,scales=ifelse(k_plot==1,"free_y","fixed")) +
scale_x_date(expand=expansion(0.02,0),breaks="1 week") +
theme_bw() + standard_theme + theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=12),
strip.text=element_text(size=17),legend.title=element_blank(),legend.text=element_text(size=17),
axis.title.y=element_text(size=19),plot.caption=element_text(size=12),panel.grid.minor.y=element_blank()) +
xlab("") + ylab("cases")
if (k_plot %in% c(1,3)){p <- p + scale_y_log10(breaks=round(2^seq(3,15,by=ifelse(k_plot==1,1/2,1)))) } else {
p<-p+scale_y_continuous(breaks=(0:16)*2e3) } # sapply(10^seq(1,4,by=1/4),function(x) round(x,max(3-round(log(x)),0)))
p
# SAVE #
ggsave(paste0("england_cases_number_10_yr_agebands_y",
ifelse(grepl("log",p$scales$scales[[2]]$trans$name),"_log","_lin"),
ifelse(k_plot>1,"_fixed","_free"),
".png",collapse=""),width=36,height=22,units="cm")
}
